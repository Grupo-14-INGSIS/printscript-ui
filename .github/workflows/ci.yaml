name: CI/CD

permissions:
  contents: read
  packages: write

on:
  push:

env:
  REGISTRY: ghcr.io

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint --if-present

      - name: Run tests
        run: npm test --if-present

      - name: Debug Auth0 Domain
        run: echo "VITE_AUTH0_DOMAIN value is ${{ secrets.VITE_AUTH0_DOMAIN }}"

      - name: Create .env file
        run: |
          echo "VITE_AUTH0_DOMAIN=${{ secrets.VITE_AUTH0_DOMAIN }}" >> .env
          echo "VITE_AUTH0_CLIENT_ID=${{ secrets.VITE_AUTH0_CLIENT_ID }}" >> .env
          echo "VITE_AUTH0_AUDIENCE=${{ secrets.VITE_AUTH0_AUDIENCE }}" >> .env
          echo "VITE_AUTH0_REALM=${{ secrets.VITE_AUTH0_REALM }}" >> .env
          echo "VITE_BACKEND_URL=${{ secrets.VITE_BACKEND_URL }}" >> .env

      - name: Build production bundle
        run: npm run build

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        run: |
          branch=${GITHUB_REF_NAME}
          docker build -t ghcr.io/grupo-14-ingsis/printscript-ui:$branch .
          docker push ghcr.io/grupo-14-ingsis/printscript-ui:$branch

  dispatch-to-infrastructure:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Notify infrastructure of new image
        run: |
          branch=${GITHUB_REF_NAME}
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.PAT }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/Grupo-14-INGSIS/SnippetSearcher-Infrastructure/dispatches \
            -d '{
              "event_type": "new-image-ready",
              "client_payload": {
                "environment": "$branch",
                "service": "snippetsearcher-ui"
              }
            }'